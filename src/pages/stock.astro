---
// src/pages/stock.astro
import AppLayout from '../layouts/AppLayout.astro';
---
<AppLayout title="Stock">
  <style>
    .page-header { margin-bottom: var(--space-6); }
    .page-header h2 { margin-bottom: var(--space-1); }
    .page-header p { color: var(--text-muted); margin: 0; }

    .toolbar {
      display: flex; gap: var(--space-4); align-items: center;
      flex-wrap: wrap; margin-bottom: var(--space-6);
    }
    .toolbar input[type="search"] { flex: 1; min-width: 200px; }
    .filter-check { display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-sm); cursor: pointer; }

    .stock-wrap { overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; font-size: var(--font-sm); }
    thead { background: var(--gray-50); border-bottom: 2px solid var(--border); }
    th { padding: var(--space-3) var(--space-4); text-align: left; font-weight: 600; color: var(--gray-700); font-size: var(--font-xs); text-transform: uppercase; letter-spacing: 0.05em; }
    td { padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border); color: var(--gray-700); }
    tbody tr:hover { background: var(--gray-50); }
    tbody tr:last-child td { border-bottom: none; }

    .qty-low { color: #dc2626; font-weight: 700; }
    .badge-low { background: #fef2f2; color: #dc2626; font-size: var(--font-xs); padding: 0.1em 0.5em; border-radius: 999px; font-weight: 600; margin-left: var(--space-1); }
    .loading { text-align: center; padding: var(--space-8); color: var(--text-muted); }
  </style>

  <div class="page-header">
    <h2>ðŸ“¦ Stock</h2>
    <p>Inventario completo del hogar.</p>
  </div>

  <div class="toolbar">
    <input type="search" id="search" placeholder="Buscar productoâ€¦" />
    <label class="filter-check">
      <input type="checkbox" id="filter-low" />
      Solo stock bajo
    </label>
  </div>

  <div class="stock-wrap">
    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>CategorÃ­a</th>
          <th>Cantidad</th>
          <th>MÃ­n.</th>
          <th>UbicaciÃ³n</th>
          <th>Vence</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="loading">Cargandoâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { apiFetch } from '/src/lib/auth-client.js';

    let allItems = [];

    function render(items) {
      const tbody = document.getElementById('tbody');
      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Sin resultados.</td></tr>';
        return;
      }
      tbody.innerHTML = items.map(item => {
        const low = item.cantidad_disponible <= item.stock_minimo;
        return `<tr>
          <td>${item.tipo_nombre}${low ? '<span class="badge-low">Bajo</span>' : ''}</td>
          <td>${item.categoria_nombre || 'â€“'}</td>
          <td class="${low ? 'qty-low' : ''}">${item.cantidad_disponible} ${item.unidad_simbolo}</td>
          <td>${item.stock_minimo} ${item.unidad_simbolo}</td>
          <td>${item.ubicacion || 'â€“'}</td>
          <td>${item.fecha_vencimiento || 'â€“'}</td>
        </tr>`;
      }).join('');
    }

    function filter() {
      const q   = document.getElementById('search').value.toLowerCase();
      const low = document.getElementById('filter-low').checked;
      let items = allItems;
      if (q)   items = items.filter(i => i.tipo_nombre.toLowerCase().includes(q));
      if (low) items = items.filter(i => i.cantidad_disponible <= i.stock_minimo);
      render(items);
    }

    document.getElementById('search').addEventListener('input', filter);
    document.getElementById('filter-low').addEventListener('change', filter);

    const data = await apiFetch('/stock');
    if (data?.success) {
      allItems = data.data;
      render(allItems);
    } else {
      document.getElementById('tbody').innerHTML =
        '<tr><td colspan="6" class="loading">Error al cargar el stock.</td></tr>';
    }
  </script>
</AppLayout>
