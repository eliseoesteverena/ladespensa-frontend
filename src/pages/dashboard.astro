---
// src/pages/dashboard.astro
import AppLayout from '../layouts/AppLayout.astro';
---
<AppLayout title="Dashboard">
  <style>
    .page-header { margin-bottom: var(--space-8); }
    .page-header h2 { margin-bottom: var(--space-1); }
    .page-header p { color: var(--text-muted); margin: 0; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }

    .stat-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-6);
    }

    .stat-card .val { font-size: var(--font-3xl); font-weight: 700; color: var(--gray-900); display: block; }
    .stat-card .lbl { font-size: var(--font-sm); color: var(--text-muted); }
    .stat-card.alert-card { border-color: #fecaca; background: #fef2f2; }
    .stat-card.alert-card .val { color: #dc2626; }

    .section-title { font-size: var(--font-lg); font-weight: 600; margin-bottom: var(--space-4); }

    .item-list { border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: var(--space-8); }
    .item-row { display: flex; align-items: center; gap: var(--space-4); padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border); }
    .item-row:last-child { border-bottom: none; }
    .item-row:hover { background: var(--gray-50); }
    .item-main { flex: 1; }
    .item-main strong { display: block; font-size: var(--font-sm); }
    .item-main small { color: var(--text-muted); font-size: var(--font-xs); }
    .item-end { font-weight: 600; font-size: var(--font-sm); }
    .badge-low { background: #fef2f2; color: #dc2626; font-size: var(--font-xs); padding: 0.1em 0.5em; border-radius: 999px; font-weight: 600; margin-left: var(--space-2); }

    .empty { text-align: center; padding: var(--space-12); color: var(--text-muted); }
    .empty .icon { font-size: 2rem; display: block; margin-bottom: var(--space-3); }
    .loading { padding: var(--space-6); color: var(--text-muted); font-size: var(--font-sm); text-align: center; }

    .quick-actions { display: flex; gap: var(--space-4); flex-wrap: wrap; margin-bottom: var(--space-8); }
  </style>

  <div class="page-header">
    <h2 id="greeting">Bienvenido</h2>
    <p id="ws-name">Cargando‚Ä¶</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <span class="val" id="stat-total">‚Äì</span>
      <span class="lbl">Productos en stock</span>
    </div>
    <div class="stat-card alert-card">
      <span class="val" id="stat-alertas">‚Äì</span>
      <span class="lbl">Stock bajo</span>
    </div>
    <div class="stat-card">
      <span class="val" id="stat-compras">‚Äì</span>
      <span class="lbl">Compras registradas</span>
    </div>
  </div>

  <div class="quick-actions">
    <a href="/stock"><button type="button">üì¶ Ver stock</button></a>
    <a href="/compras"><button type="button" data-variant="secondary">üõí Compras</button></a>
  </div>

  <p class="section-title">‚ö†Ô∏è Stock bajo</p>
  <div class="item-list" id="alert-list"><div class="loading">Cargando‚Ä¶</div></div>

  <p class="section-title">üõí √öltimas compras</p>
  <div class="item-list" id="compras-list"><div class="loading">Cargando‚Ä¶</div></div>

  <script>
    import { apiFetch, getToken } from '/src/lib/auth-client.js';

    // Greeting
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    const h    = new Date().getHours();
    const greet = h < 12 ? 'Buenos d√≠as' : h < 19 ? 'Buenas tardes' : 'Buenas noches';
    if (user) {
      document.getElementById('greeting').textContent =
        `${greet}, ${user.email?.split('@')[0] || ''} üëã`;
      document.getElementById('ws-name').textContent = `Hogar: ${user.tenantName || '‚Äì'}`;
    }

    // Stock con alertas
    async function loadAlerts() {
      const el = document.getElementById('alert-list');
      const data = await apiFetch('/stock?alertas=true');
      if (!data?.success) { el.innerHTML = '<div class="loading">Error al cargar.</div>'; return; }

      const items = data.data;
      document.getElementById('stat-alertas').textContent = items.length;

      if (!items.length) {
        el.innerHTML = '<div class="empty"><span class="icon">‚úÖ</span>Todo el stock est√° al d√≠a.</div>';
        return;
      }

      el.innerHTML = items.map(i => `
        <div class="item-row">
          <div class="item-main">
            <strong>${i.tipo_nombre}<span class="badge-low">Bajo</span></strong>
            <small>${i.categoria_nombre || ''} ¬∑ ${i.ubicacion || ''}</small>
          </div>
          <div class="item-end">${i.cantidad_disponible} ${i.unidad_simbolo}</div>
        </div>`).join('');
    }

    // Total stock
    async function loadTotal() {
      const data = await apiFetch('/stock');
      if (data?.success) document.getElementById('stat-total').textContent = data.data.length;
    }

    // √öltimas compras
    async function loadCompras() {
      const el   = document.getElementById('compras-list');
      const data = await apiFetch('/compras');
      if (!data?.success) { el.innerHTML = '<div class="loading">Error al cargar.</div>'; return; }

      const items = data.data;
      document.getElementById('stat-compras').textContent = items.length;

      if (!items.length) {
        el.innerHTML = '<div class="empty"><span class="icon">üõí</span>A√∫n no registraste compras.</div>';
        return;
      }

      el.innerHTML = items.slice(0, 5).map(c => `
        <div class="item-row">
          <div class="item-main">
            <strong>${c.lugar_compra || 'Sin nombre'}</strong>
            <small>${new Date(c.fecha).toLocaleDateString('es-AR')}</small>
          </div>
          <div class="item-end">$${(c.total || 0).toLocaleString('es-AR')}</div>
        </div>`).join('');
    }

    // Obtener token UNA VEZ antes de lanzar fetches en paralelo.
    // Esto garantiza que cuando los 3 apiFetch() se ejecuten, ya haya
    // un accessToken en window.__despensa y no disparen refreshes paralelos.
    const ready = await getToken();
    if (!ready) return; // forceLogout() ya redirigi√≥

    loadAlerts();
    loadTotal();
    loadCompras();
  </script>
</AppLayout>
