---
// src/pages/configuracion.astro
// PÃ¡gina protegida: configuraciÃ³n de cuenta del usuario.
import AppLayout from '../layouts/AppLayout.astro';
---
<AppLayout title="ConfiguraciÃ³n">
  <style>
    .page-header { margin-bottom: var(--space-8); }
    .page-header h2 { margin-bottom: var(--space-1); }
    .page-header p { color: var(--text-muted); margin: 0; }

    .settings-grid {
      display: grid;
      gap: var(--space-6);
      max-width: 640px;
    }

    .settings-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
    }

    .settings-card h4 { margin-bottom: var(--space-4); }

    .form-group { margin-bottom: var(--space-4); }
    .form-group:last-of-type { margin-bottom: 0; }

    .form-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }

    .alert-msg {
      border-radius: var(--radius-md);
      font-size: var(--font-sm);
      padding: var(--space-3) var(--space-4);
      margin-bottom: var(--space-4);
      display: none;
    }

    .alert-msg.visible { display: block; }
    .alert-msg.error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
    .alert-msg.success { background: var(--accent-light); border: 1px solid #bbf7d0; color: var(--accent-dark); }

    .role-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent-dark);
      font-size: var(--font-xs);
      font-weight: 600;
      padding: 0.2em 0.6em;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .sessions-list {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .session-item {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border);
      font-size: var(--font-sm);
    }

    .session-item:last-child { border-bottom: none; }

    .session-info { flex: 1; }
    .session-info strong { display: block; font-size: var(--font-xs); }
    .session-info small { color: var(--text-muted); }

    .loading { color: var(--text-muted); font-size: var(--font-sm); padding: var(--space-4); }
  </style>

  <div class="page-header">
    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
    <p>GestionÃ¡ tu perfil, contraseÃ±a y sesiones activas.</p>
  </div>

  <div class="settings-grid">

    <!-- â”€â”€ Perfil â”€â”€ -->
    <div class="settings-card">
      <h4>ğŸ‘¤ Perfil</h4>

      <div class="alert-msg" id="perfil-msg"></div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="user-email" disabled />
      </div>

      <div class="form-group">
        <label>Rol <span class="role-badge" id="user-role">â€“</span></label>
      </div>

      <div class="form-group">
        <label for="display-name">Nombre para mostrar</label>
        <input type="text" id="display-name" placeholder="Tu nombre" maxlength="80" />
      </div>

      <div class="form-group">
        <label for="avatar-url">URL de avatar</label>
        <input type="url" id="avatar-url" placeholder="https://â€¦" />
      </div>

      <div class="form-actions">
        <button type="button" id="btn-save-perfil">Guardar cambios</button>
      </div>
    </div>

    <!-- â”€â”€ Hogar â”€â”€ -->
    <div class="settings-card">
      <h4>ğŸ  Hogar</h4>

      <div class="alert-msg" id="hogar-msg"></div>

      <div class="form-group">
        <label>ID del hogar</label>
        <input type="text" id="tenant-id" disabled />
      </div>

      <div class="form-group">
        <label for="workspace-name">Nombre del hogar</label>
        <input type="text" id="workspace-name" placeholder="Casa GarcÃ­a" />
        <small id="workspace-owner-note" style="display:none; margin-top:4px; color: var(--text-muted);">
          Solo el <strong>owner</strong> puede renombrar el hogar.
        </small>
      </div>

      <div class="form-actions">
        <button type="button" id="btn-save-hogar">Guardar nombre</button>
      </div>
    </div>

    <!-- â”€â”€ ContraseÃ±a â”€â”€ -->
    <div class="settings-card">
      <h4>ğŸ”‘ Cambiar contraseÃ±a</h4>

      <div class="alert-msg" id="pass-msg"></div>

      <div class="form-group">
        <label for="current-pass">ContraseÃ±a actual</label>
        <input type="password" id="current-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div>

      <div class="form-group">
        <label for="new-pass">Nueva contraseÃ±a</label>
        <input type="password" id="new-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
        <small style="display:block; margin-top:4px; color: var(--text-muted);">
          MÃ­n. 8 caracteres Â· 1 mayÃºscula Â· 1 nÃºmero Â· 1 sÃ­mbolo especial
        </small>
      </div>

      <div class="form-actions">
        <button type="button" id="btn-save-pass">Cambiar contraseÃ±a</button>
      </div>
    </div>

    <!-- â”€â”€ Sesiones activas â”€â”€ -->
    <div class="settings-card">
      <h4>ğŸ“± Sesiones activas</h4>
      <div id="sessions-list" class="sessions-list">
        <div class="loading">Cargando sesionesâ€¦</div>
      </div>
    </div>

  </div>

  <script>
    const API = 'https://ladespensa-services.eliseo050595.workers.dev';
    let accessToken = null;

    // â”€â”€ Token helper (igual que dashboard) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function getToken() {
      if (accessToken) return accessToken;
      const rt = localStorage.getItem('refreshToken');
      if (!rt) { window.location.href = '/login'; return null; }

      const res = await fetch(`${API}/auth/refresh`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh_token: rt }),
      });

      if (!res.ok) { window.location.href = '/login'; return null; }

      const data = await res.json();
      accessToken = data.accessToken;
      localStorage.setItem('refreshToken', data.refreshToken);
      document.cookie = `refreshToken=${data.refreshToken}; Max-Age=${30*24*60*60}; path=/; SameSite=Strict`;
      return accessToken;
    }

    async function apiFetch(path, options = {}) {
      const token = await getToken();
      if (!token) return null;
      const headers = { 'Authorization': `Bearer ${token}`, ...options.headers };
      if (!(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(`${API}${path}`, { ...options, headers });
      if (res.status === 401) { accessToken = null; return apiFetch(path, options); }
      return res.json();
    }

    // â”€â”€ Feedback helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showMsg(id, type, text) {
      const el = document.getElementById(id);
      el.className = `alert-msg ${type} visible`;
      el.textContent = text;
      setTimeout(() => el.classList.remove('visible'), 5000);
    }

    // â”€â”€ Cargar datos del perfil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadProfile() {
      const data = await apiFetch('/account/me');
      if (!data?.success) return;

      const u = data.data;
      document.getElementById('user-email').value = u.email;
      document.getElementById('user-role').textContent = u.role;
      document.getElementById('display-name').value = u.display_name || '';
      document.getElementById('avatar-url').value = u.avatar_url || '';

      // Actualizar localStorage
      const stored = JSON.parse(localStorage.getItem('user') || '{}');
      localStorage.setItem('user', JSON.stringify({ ...stored, ...u }));
    }

    // â”€â”€ Cargar datos del hogar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadWorkspace() {
      const data = await apiFetch('/account/workspace');
      if (!data?.success) return;

      const w = data.data;
      document.getElementById('tenant-id').value = w.id || w.tenant_id || '';
      document.getElementById('workspace-name').value = w.workspace_name || w.name || '';

      // Solo owner puede renombrar
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.role !== 'owner') {
        document.getElementById('workspace-name').disabled = true;
        document.getElementById('btn-save-hogar').disabled = true;
        document.getElementById('workspace-owner-note').style.display = 'block';
      }
    }

    // â”€â”€ Cargar sesiones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSessions() {
      const data = await apiFetch('/account/sessions');
      const list = document.getElementById('sessions-list');

      if (!data?.success) {
        list.innerHTML = '<div class="loading">Error al cargar sesiones.</div>';
        return;
      }

      const sessions = data.data;
      if (sessions.length === 0) {
        list.innerHTML = '<div class="loading">No hay sesiones activas.</div>';
        return;
      }

      list.innerHTML = sessions.map(s => `
        <div class="session-item">
          <div class="session-info">
            <strong>${s.user_agent?.substring(0, 50) || 'Dispositivo desconocido'}â€¦</strong>
            <small>IP: ${s.ip_address || 'â€“'} Â· ${new Date(s.created_at).toLocaleDateString('es-AR')}</small>
          </div>
          <button type="button" data-variant="danger"
                  style="font-size: var(--font-xs); padding: var(--space-1) var(--space-3);"
                  onclick="revokeSession('${s.jti}', this)">
            Cerrar
          </button>
        </div>
      `).join('');
    }

    window.revokeSession = async function(jti, btn) {
      btn.disabled = true;
      btn.textContent = 'â€¦';
      await apiFetch(`/account/sessions/${jti}`, { method: 'DELETE' });
      btn.closest('.session-item').remove();
    };

    // â”€â”€ Guardar perfil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-save-perfil').addEventListener('click', async () => {
      const payload = {};
      const dn = document.getElementById('display-name').value.trim();
      const au = document.getElementById('avatar-url').value.trim();
      if (dn) payload.display_name = dn;
      if (au) payload.avatar_url = au;

      const data = await apiFetch('/account/me', {
        method: 'PATCH',
        body: JSON.stringify(payload),
      });

      if (data?.success) {
        showMsg('perfil-msg', 'success', 'âœ“ Perfil actualizado correctamente.');
        localStorage.setItem('user', JSON.stringify({
          ...JSON.parse(localStorage.getItem('user') || '{}'),
          ...data.data,
        }));
      } else {
        showMsg('perfil-msg', 'error', data?.error?.message || 'Error al guardar.');
      }
    });

    // â”€â”€ Guardar nombre de hogar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-save-hogar').addEventListener('click', async () => {
      const workspace_name = document.getElementById('workspace-name').value.trim();
      if (!workspace_name) return;

      const data = await apiFetch('/account/workspace', {
        method: 'PATCH',
        body: JSON.stringify({ workspace_name }),
      });

      if (data?.success) {
        showMsg('hogar-msg', 'success', 'âœ“ Nombre del hogar actualizado.');
        const stored = JSON.parse(localStorage.getItem('user') || '{}');
        stored.tenantName = workspace_name;
        localStorage.setItem('user', JSON.stringify(stored));
      } else {
        showMsg('hogar-msg', 'error', data?.error?.message || 'Error al guardar.');
      }
    });

    // â”€â”€ Cambiar contraseÃ±a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-save-pass').addEventListener('click', async () => {
      const current_password = document.getElementById('current-pass').value;
      const new_password = document.getElementById('new-pass').value;

      if (!current_password || !new_password) {
        showMsg('pass-msg', 'error', 'CompletÃ¡ ambos campos.');
        return;
      }

      const data = await apiFetch('/account/me/password', {
        method: 'PATCH',
        body: JSON.stringify({ current_password, new_password }),
      });

      if (data?.success) {
        showMsg('pass-msg', 'success', 'âœ“ ContraseÃ±a actualizada.');
        document.getElementById('current-pass').value = '';
        document.getElementById('new-pass').value = '';
      } else {
        showMsg('pass-msg', 'error', data?.error?.message || 'Error al cambiar contraseÃ±a.');
      }
    });

    // â”€â”€ Inicializar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadProfile();
    loadWorkspace();
    loadSessions();
  </script>
</AppLayout>
