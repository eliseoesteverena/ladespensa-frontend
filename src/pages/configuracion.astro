---
// src/pages/configuracion.astro
import AppLayout from '../layouts/AppLayout.astro';
---
<AppLayout title="ConfiguraciÃ³n">
  <style>
    .page-header { margin-bottom: var(--space-8); }
    .page-header h2 { margin-bottom: var(--space-1); }
    .page-header p { color: var(--text-muted); margin: 0; }

    .settings-grid { display: grid; gap: var(--space-6); max-width: 640px; }

    .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: var(--space-6); }
    .card h4 { margin-bottom: var(--space-4); }

    .form-group { margin-bottom: var(--space-4); }

    .actions { display: flex; gap: var(--space-3); margin-top: var(--space-4); flex-wrap: wrap; }

    .msg { border-radius: var(--radius-md); font-size: var(--font-sm); padding: var(--space-3) var(--space-4); margin-bottom: var(--space-4); display: none; }
    .msg.visible { display: block; }
    .msg.error   { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
    .msg.success { background: var(--accent-light); border: 1px solid #bbf7d0; color: var(--accent-dark); }

    .role-badge { display: inline-block; background: var(--accent-light); color: var(--accent-dark); font-size: var(--font-xs); font-weight: 600; padding: 0.2em 0.6em; border-radius: 999px; text-transform: uppercase; letter-spacing: 0.05em; }

    .sessions { border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
    .session-row { display: flex; align-items: center; gap: var(--space-4); padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--border); font-size: var(--font-sm); }
    .session-row:last-child { border-bottom: none; }
    .session-info { flex: 1; }
    .session-info strong { display: block; font-size: var(--font-xs); }
    .session-info small { color: var(--text-muted); }

    .loading { padding: var(--space-4); color: var(--text-muted); font-size: var(--font-sm); }
  </style>

  <div class="page-header">
    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
    <p>GestionÃ¡ tu perfil, contraseÃ±a y sesiones activas.</p>
  </div>

  <div class="settings-grid">

    <div class="card">
      <h4>ğŸ‘¤ Perfil</h4>
      <div class="msg" id="msg-perfil"></div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="f-email" disabled />
      </div>
      <div class="form-group">
        <label>Rol <span class="role-badge" id="f-role">â€“</span></label>
      </div>
      <div class="form-group">
        <label for="f-name">Nombre para mostrar</label>
        <input type="text" id="f-name" placeholder="Tu nombre" maxlength="80" />
      </div>
      <div class="form-group">
        <label for="f-avatar">URL de avatar</label>
        <input type="url" id="f-avatar" placeholder="https://â€¦" />
      </div>
      <div class="actions">
        <button type="button" id="btn-perfil">Guardar cambios</button>
      </div>
    </div>

    <div class="card">
      <h4>ğŸ  Hogar</h4>
      <div class="msg" id="msg-hogar"></div>
      <div class="form-group">
        <label>ID del hogar</label>
        <input type="text" id="f-tenant" disabled />
      </div>
      <div class="form-group">
        <label for="f-ws">Nombre del hogar</label>
        <input type="text" id="f-ws" placeholder="Casa GarcÃ­a" />
        <small id="note-owner" style="display:none; margin-top:4px; color:var(--text-muted);">
          Solo el <strong>owner</strong> puede renombrar el hogar.
        </small>
      </div>
      <div class="actions">
        <button type="button" id="btn-hogar">Guardar nombre</button>
      </div>
    </div>

    <div class="card">
      <h4>ğŸ”‘ Cambiar contraseÃ±a</h4>
      <div class="msg" id="msg-pass"></div>
      <div class="form-group">
        <label for="f-curr">ContraseÃ±a actual</label>
        <input type="password" id="f-curr" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div>
      <div class="form-group">
        <label for="f-new">Nueva contraseÃ±a</label>
        <input type="password" id="f-new" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
        <small style="display:block;margin-top:4px;color:var(--text-muted);">MÃ­n. 8 Â· 1 mayÃºscula Â· 1 nÃºmero Â· 1 sÃ­mbolo</small>
      </div>
      <div class="actions">
        <button type="button" id="btn-pass">Cambiar contraseÃ±a</button>
      </div>
    </div>

    <div class="card">
      <h4>ğŸ“± Sesiones activas</h4>
      <div class="sessions" id="sessions"><div class="loading">Cargandoâ€¦</div></div>
    </div>

  </div>

  <script type="module">
    import { apiFetch } from '/src/lib/auth-client.js';

    function showMsg(id, type, text) {
      const el = document.getElementById(id);
      el.className = `msg ${type} visible`;
      el.textContent = text;
      setTimeout(() => el.classList.remove('visible'), 5000);
    }

    // â”€â”€ Cargar perfil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const profileData = await apiFetch('/account/me');
    if (profileData?.success) {
      const u = profileData.data;
      document.getElementById('f-email').value  = u.email || '';
      document.getElementById('f-role').textContent = u.role || 'â€“';
      document.getElementById('f-name').value  = u.display_name || '';
      document.getElementById('f-avatar').value = u.avatar_url || '';
      // Actualizar cachÃ© local
      const cached = JSON.parse(localStorage.getItem('user') || '{}');
      localStorage.setItem('user', JSON.stringify({ ...cached, ...u }));
    }

    // â”€â”€ Cargar hogar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const wsData = await apiFetch('/account/workspace');
    if (wsData?.success) {
      const w = wsData.data;
      document.getElementById('f-tenant').value = w.id || w.tenant_id || '';
      document.getElementById('f-ws').value     = w.workspace_name || w.name || '';
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (user.role !== 'owner') {
        document.getElementById('f-ws').disabled       = true;
        document.getElementById('btn-hogar').disabled  = true;
        document.getElementById('note-owner').style.display = 'block';
      }
    }

    // â”€â”€ Cargar sesiones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSessions() {
      const el   = document.getElementById('sessions');
      const data = await apiFetch('/account/sessions');
      if (!data?.success || !data.data.length) {
        el.innerHTML = '<div class="loading">No hay sesiones activas.</div>';
        return;
      }
      el.innerHTML = data.data.map(s => `
        <div class="session-row">
          <div class="session-info">
            <strong>${(s.user_agent || 'Dispositivo desconocido').substring(0, 55)}</strong>
            <small>IP: ${s.ip_address || 'â€“'} Â· ${new Date(s.created_at).toLocaleDateString('es-AR')}</small>
          </div>
          <button type="button" data-variant="danger"
                  style="font-size:var(--font-xs);padding:var(--space-1) var(--space-3);"
                  onclick="revokeSession('${s.jti}', this)">Cerrar</button>
        </div>`).join('');
    }
    loadSessions();

    window.revokeSession = async (jti, btn) => {
      btn.disabled = true; btn.textContent = 'â€¦';
      await apiFetch(`/account/sessions/${jti}`, { method: 'DELETE' });
      btn.closest('.session-row').remove();
    };

    // â”€â”€ Guardar perfil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-perfil').addEventListener('click', async () => {
      const payload = {};
      const dn = document.getElementById('f-name').value.trim();
      const av = document.getElementById('f-avatar').value.trim();
      if (dn) payload.display_name = dn;
      if (av) payload.avatar_url   = av;
      const data = await apiFetch('/account/me', { method: 'PATCH', body: JSON.stringify(payload) });
      if (data?.success) {
        showMsg('msg-perfil', 'success', 'âœ“ Perfil actualizado.');
        const cached = JSON.parse(localStorage.getItem('user') || '{}');
        localStorage.setItem('user', JSON.stringify({ ...cached, ...data.data }));
      } else {
        showMsg('msg-perfil', 'error', data?.error?.message || 'Error al guardar.');
      }
    });

    // â”€â”€ Guardar hogar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-hogar').addEventListener('click', async () => {
      const workspace_name = document.getElementById('f-ws').value.trim();
      if (!workspace_name) return;
      const data = await apiFetch('/account/workspace', { method: 'PATCH', body: JSON.stringify({ workspace_name }) });
      if (data?.success) {
        showMsg('msg-hogar', 'success', 'âœ“ Nombre del hogar actualizado.');
        const cached = JSON.parse(localStorage.getItem('user') || '{}');
        cached.tenantName = workspace_name;
        localStorage.setItem('user', JSON.stringify(cached));
      } else {
        showMsg('msg-hogar', 'error', data?.error?.message || 'Error al guardar.');
      }
    });

    // â”€â”€ Cambiar contraseÃ±a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('btn-pass').addEventListener('click', async () => {
      const current_password = document.getElementById('f-curr').value;
      const new_password     = document.getElementById('f-new').value;
      if (!current_password || !new_password) {
        showMsg('msg-pass', 'error', 'CompletÃ¡ ambos campos.'); return;
      }
      const data = await apiFetch('/account/me/password', {
        method: 'PATCH',
        body: JSON.stringify({ current_password, new_password }),
      });
      if (data?.success) {
        showMsg('msg-pass', 'success', 'âœ“ ContraseÃ±a actualizada.');
        document.getElementById('f-curr').value = '';
        document.getElementById('f-new').value  = '';
      } else {
        showMsg('msg-pass', 'error', data?.error?.message || 'Error al cambiar contraseÃ±a.');
      }
    });
  </script>
</AppLayout>
